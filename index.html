<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JPYCå¯¾å¿œã‚µãƒ¼ãƒ“ã‚¹ãƒãƒƒãƒ—</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    .tab-active {
      border-bottom: 2px solid #3b82f6;
      color: #3b82f6;
    }
    .tab-inactive {
      border-bottom: 2px solid transparent;
      color: #6b7280;
    }
    .tab-inactive:hover {
      color: #374151;
      border-bottom-color: #d1d5db;
    }
    #map {
      height: 400px;
      width: 100%;
      border-radius: 0.5rem;
    }
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">JPYCå¯¾å¿œã‚µãƒ¼ãƒ“ã‚¹ãƒãƒƒãƒ—</h1>
          <p class="mt-1 text-sm text-gray-500">JPYCãŒä½¿ãˆã‚‹åº—èˆ—ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¢ãã†</p>
        </div>
        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
          <span class="text-white font-bold text-sm">JP</span>
        </div>
      </div>
    </div>
  </header>

  <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="flex space-x-8">
        <button id="tab-shops" onclick="switchTab('shops')" class="py-4 px-1 font-medium text-sm transition-colors tab-active flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          å®Ÿåº—èˆ—ï¼ˆåœ°å›³ï¼‰
        </button>
        <button id="tab-online" onclick="switchTab('online')" class="py-4 px-1 font-medium text-sm transition-colors tab-inactive flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
          </svg>
          ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äº‹æ¥­è€…ä¸€è¦§
        </button>
      </nav>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- å®Ÿåº—èˆ—ã‚¿ãƒ– -->
    <div id="content-shops" class="space-y-6">
      <!-- æ¤œç´¢åŠå¾„ -->
      <div class="bg-white p-4 rounded-lg shadow">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          æ¤œç´¢åŠå¾„: <span id="radius-value">10</span>km
        </label>
        <input type="range" id="radius-slider" min="1" max="50" value="10"
               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
               oninput="updateRadius(this.value)">
        <div class="flex justify-between text-xs text-gray-500 mt-1">
          <span>1km</span>
          <span>50km</span>
        </div>
      </div>

      <!-- åœ°å›³ -->
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div id="map"></div>
      </div>

      <!-- åº—èˆ—ä¸€è¦§ -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">å‘¨è¾ºã®åº—èˆ— (<span id="shops-count">0</span>ä»¶)</h2>
        </div>
        <div id="shops-list" class="divide-y divide-gray-200"></div>
      </div>
    </div>

    <!-- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äº‹æ¥­è€…ã‚¿ãƒ– -->
    <div id="content-online" class="space-y-6 hidden">
      <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <div class="bg-white p-4 rounded-lg shadow">
        <div class="flex flex-col sm:flex-row gap-4">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
            <input type="text" id="search-query" placeholder="ã‚µãƒ¼ãƒ“ã‚¹åã€èª¬æ˜ã€ã‚¿ã‚°ã§æ¤œç´¢..."
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   oninput="filterMerchants()">
          </div>
          <div class="sm:w-48">
            <label class="block text-sm font-medium text-gray-700 mb-1">ã‚µãƒ¼ãƒ“ã‚¹ã‚¿ã‚¤ãƒ—</label>
            <select id="service-type-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    onchange="filterMerchants()">
              <option value="all">ã™ã¹ã¦</option>
            </select>
          </div>
        </div>
      </div>

      <!-- çµæœä»¶æ•° -->
      <div class="text-sm text-gray-600">
        <span id="merchants-count">0</span>ä»¶ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ
      </div>

      <!-- ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
      <div id="merchants-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

  </main>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <footer class="bg-white border-t border-gray-200 mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <p class="text-sm text-gray-500">JPYCå¯¾å¿œã‚µãƒ¼ãƒ“ã‚¹ãƒãƒƒãƒ— - JPYCãŒä½¿ãˆã‚‹å ´æ‰€ã‚’è¦‹ã¤ã‘ã‚ˆã†</p>
        <a href="https://jpyc.jp" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-500 hover:text-blue-500 transition-colors">
          JPYCå…¬å¼ã‚µã‚¤ãƒˆ
        </a>
      </div>
    </div>
  </footer>

  <script>
    // ========================================
    // è¨­å®š
    // ========================================
    const USE_DUMMY_DATA = true; // Supabaseæ¥ç¶šæ™‚ã¯falseã«
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

    // ========================================
    // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
    // ========================================
    const dummyShops = [
      {
        id: '1',
        name: 'Crypto Cafe Tokyo',
        address: 'æ±äº¬éƒ½æ¸‹è°·åŒºç¥å®®å‰1-2-3',
        lat: 35.6695,
        lng: 139.7025,
        jpyc_networks: ['Ethereum', 'Polygon'],
        payment_methods: ['QRã‚³ãƒ¼ãƒ‰æ±ºæ¸ˆ', 'ã‚¦ã‚©ãƒ¬ãƒƒãƒˆé€é‡‘'],
        url: 'https://example.com/crypto-cafe',
        tags: ['ã‚«ãƒ•ã‚§', 'ã‚³ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°'],
        upvotes: 15,
        downvotes: 2
      },
      {
        id: '2',
        name: 'Web3 Burger',
        address: 'æ±äº¬éƒ½æ–°å®¿åŒºæ–°å®¿3-4-5',
        lat: 35.6896,
        lng: 139.7006,
        jpyc_networks: ['Polygon', 'Avalanche'],
        payment_methods: ['QRã‚³ãƒ¼ãƒ‰æ±ºæ¸ˆ'],
        url: 'https://example.com/web3-burger',
        tags: ['ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', 'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰'],
        upvotes: 22,
        downvotes: 1
      },
      {
        id: '3',
        name: 'NFT Art Gallery',
        address: 'æ±äº¬éƒ½æ¸¯åŒºå…­æœ¬æœ¨6-7-8',
        lat: 35.6627,
        lng: 139.7295,
        jpyc_networks: ['Ethereum'],
        payment_methods: ['ã‚¦ã‚©ãƒ¬ãƒƒãƒˆé€é‡‘'],
        url: 'https://example.com/nft-gallery',
        tags: ['ã‚¢ãƒ¼ãƒˆ', 'ã‚®ãƒ£ãƒ©ãƒªãƒ¼'],
        upvotes: 8,
        downvotes: 0
      },
      {
        id: '4',
        name: 'Blockchain Books',
        address: 'æ±äº¬éƒ½åƒä»£ç”°åŒºç¥ç”°ç¥ä¿ç”º1-2-3',
        lat: 35.6959,
        lng: 139.7576,
        jpyc_networks: ['Polygon'],
        payment_methods: ['QRã‚³ãƒ¼ãƒ‰æ±ºæ¸ˆ', 'ã‚¦ã‚©ãƒ¬ãƒƒãƒˆé€é‡‘'],
        url: 'https://example.com/blockchain-books',
        tags: ['æ›¸åº—', 'æŠ€è¡“æ›¸'],
        upvotes: 12,
        downvotes: 3
      }
    ];

    const dummyOnlineMerchants = [
      {
        id: '1',
        name: 'CryptoMall',
        description: 'ä»®æƒ³é€šè²¨ã§è³¼å…¥ã§ãã‚‹ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ«ã€‚æ—¥ç”¨å“ã‹ã‚‰é›»å­æ©Ÿå™¨ã¾ã§å¹…åºƒãå–ã‚Šæ‰±ã„ã€‚',
        service_type: 'ECã‚µã‚¤ãƒˆ',
        url: 'https://cryptomall.example.com',
        platforms: ['Web', 'iOS', 'Android'],
        jpyc_use_case: 'å•†å“è³¼å…¥',
        country: 'æ—¥æœ¬',
        tags: ['ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°', 'EC', 'æ—¥ç”¨å“']
      },
      {
        id: '2',
        name: 'GameFi Arena',
        description: 'Play-to-Earnã‚²ãƒ¼ãƒ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‚JPYCã§ã‚²ãƒ¼ãƒ å†…ã‚¢ã‚¤ãƒ†ãƒ ã‚’è³¼å…¥å¯èƒ½ã€‚',
        service_type: 'ã‚²ãƒ¼ãƒ ',
        url: 'https://gamefi-arena.example.com',
        platforms: ['Web', 'PC'],
        jpyc_use_case: 'ã‚²ãƒ¼ãƒ å†…èª²é‡‘',
        country: 'æ—¥æœ¬',
        tags: ['ã‚²ãƒ¼ãƒ ', 'GameFi', 'NFT']
      },
      {
        id: '3',
        name: 'NFT Marketplace Plus',
        description: 'NFTã®å£²è²·ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‚JPYCã§ç›´æ¥NFTã‚’è³¼å…¥ã§ãã¾ã™ã€‚',
        service_type: 'NFTãƒãƒ¼ã‚±ãƒƒãƒˆ',
        url: 'https://nft-marketplace.example.com',
        platforms: ['Web'],
        jpyc_use_case: 'NFTè³¼å…¥',
        country: 'æ—¥æœ¬',
        tags: ['NFT', 'ã‚¢ãƒ¼ãƒˆ', 'ã‚³ãƒ¬ã‚¯ã‚¿ãƒ–ãƒ«']
      },
      {
        id: '4',
        name: 'DeFi Savings',
        description: 'JPYCã‚’é ã‘ã¦åˆ©å›ã‚Šã‚’å¾—ã‚‰ã‚Œã‚‹DeFiãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‚',
        service_type: 'DeFi',
        url: 'https://defi-savings.example.com',
        platforms: ['Web'],
        jpyc_use_case: 'ã‚¹ãƒ†ãƒ¼ã‚­ãƒ³ã‚°ãƒ»é é‡‘',
        country: 'æ—¥æœ¬',
        tags: ['DeFi', 'è³‡ç”£é‹ç”¨', 'ã‚¤ãƒ¼ãƒ«ãƒ‰']
      },
      {
        id: '5',
        name: 'Crypto Gift Cards',
        description: 'å„ç¨®ã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰ã‚’JPYCã§è³¼å…¥å¯èƒ½ã€‚Amazonã€iTunesã€Google Playãªã©å¯¾å¿œã€‚',
        service_type: 'ã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰',
        url: 'https://crypto-giftcards.example.com',
        platforms: ['Web', 'iOS', 'Android'],
        jpyc_use_case: 'ã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰è³¼å…¥',
        country: 'æ—¥æœ¬',
        tags: ['ã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰', 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°']
      },
      {
        id: '6',
        name: 'Web3 Learning Hub',
        description: 'ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ãƒ»Web3ã®å­¦ç¿’ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‚JPYCã§ã‚³ãƒ¼ã‚¹ã‚’è³¼å…¥ã€‚',
        service_type: 'æ•™è‚²',
        url: 'https://web3-learning.example.com',
        platforms: ['Web'],
        jpyc_use_case: 'ã‚³ãƒ¼ã‚¹è³¼å…¥',
        country: 'æ—¥æœ¬',
        tags: ['æ•™è‚²', 'å­¦ç¿’', 'ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³']
      }
    ];

    // ========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // ========================================
    let map = null;
    let markers = [];
    let userLocation = { lat: 35.6812, lng: 139.7671 }; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æ±äº¬é§…
    let searchRadius = 10;
    let shops = [];
    let onlineMerchants = [];
    let supabase = null;

    // ========================================
    // åˆæœŸåŒ–
    // ========================================
    async function init() {
      // SupabaseåˆæœŸåŒ–
      if (!USE_DUMMY_DATA && SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }

      // ç¾åœ¨åœ°å–å¾—
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            initMap();
            loadShops();
          },
          (err) => {
            console.error('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—:', err);
            initMap();
            loadShops();
          }
        );
      } else {
        initMap();
        loadShops();
      }

      // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äº‹æ¥­è€…ã‚’èª­ã¿è¾¼ã¿
      loadOnlineMerchants();
    }

    // ========================================
    // åœ°å›³åˆæœŸåŒ–
    // ========================================
    function initMap() {
      map = L.map('map').setView([userLocation.lat, userLocation.lng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼
      L.circleMarker([userLocation.lat, userLocation.lng], {
        radius: 10,
        fillColor: '#3b82f6',
        color: '#1d4ed8',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(map).bindPopup('ç¾åœ¨åœ°');
    }

    // ========================================
    // è·é›¢è¨ˆç®— (Haversine formula)
    // ========================================
    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // ========================================
    // åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    // ========================================
    async function loadShops() {
      if (USE_DUMMY_DATA || !supabase) {
        shops = dummyShops;
      } else {
        const { data, error } = await supabase
          .from('shops')
          .select('*')
          .eq('status', 'approved');
        if (error) {
          console.error('åº—èˆ—ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          shops = dummyShops;
        } else {
          shops = data || [];
        }
      }
      updateShopsDisplay();
    }

    // ========================================
    // åº—èˆ—è¡¨ç¤ºæ›´æ–°
    // ========================================
    function updateShopsDisplay() {
      // è·é›¢è¨ˆç®—ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const nearbyShops = shops
        .map(shop => ({
          ...shop,
          distance: calculateDistance(userLocation.lat, userLocation.lng, shop.lat, shop.lng)
        }))
        .filter(shop => shop.distance <= searchRadius)
        .sort((a, b) => a.distance - b.distance);

      // ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      // ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
      nearbyShops.forEach(shop => {
        const marker = L.marker([shop.lat, shop.lng])
          .addTo(map)
          .bindPopup(`
            <div style="min-width: 200px;">
              <h3 style="font-weight: bold; font-size: 1rem; margin-bottom: 0.5rem;">${shop.name}</h3>
              <p style="font-size: 0.875rem; color: #666;">${shop.address}</p>
              ${shop.jpyc_networks ? `
                <div style="margin-top: 0.5rem;">
                  ${shop.jpyc_networks.map(n => `<span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px;">${n}</span>`).join('')}
                </div>
              ` : ''}
            </div>
          `);
        markers.push(marker);
      });

      // ä»¶æ•°æ›´æ–°
      document.getElementById('shops-count').textContent = nearbyShops.length;

      // ãƒªã‚¹ãƒˆæ›´æ–°
      const listEl = document.getElementById('shops-list');
      if (nearbyShops.length === 0) {
        listEl.innerHTML = `
          <div class="p-6 text-center text-gray-500">
            <p>å‘¨è¾ºã«å¯¾å¿œåº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
            <p class="text-sm mt-1">æ¤œç´¢åŠå¾„ã‚’åºƒã’ã¦ã¿ã¦ãã ã•ã„</p>
          </div>
        `;
      } else {
        listEl.innerHTML = nearbyShops.map(shop => `
          <div class="p-4 hover:bg-gray-50 cursor-pointer transition-colors">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <h3 class="font-medium text-gray-900">${shop.name}</h3>
                <p class="text-sm text-gray-600 mt-1">${shop.address}</p>
                ${shop.jpyc_networks && shop.jpyc_networks.length > 0 ? `
                  <div class="mt-2 flex flex-wrap gap-1">
                    ${shop.jpyc_networks.map(n => `<span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">${n}</span>`).join('')}
                  </div>
                ` : ''}
                ${shop.payment_methods && shop.payment_methods.length > 0 ? `
                  <div class="mt-2 flex flex-wrap gap-1">
                    ${shop.payment_methods.map(m => `<span class="px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded">${m}</span>`).join('')}
                  </div>
                ` : ''}
                ${shop.tags && shop.tags.length > 0 ? `
                  <div class="mt-2 flex flex-wrap gap-1">
                    ${shop.tags.map(t => `<span class="px-2 py-0.5 bg-gray-100 text-gray-800 text-xs rounded">#${t}</span>`).join('')}
                  </div>
                ` : ''}
              </div>
              <div class="ml-4 text-right">
                <span class="text-sm text-gray-500">${shop.distance.toFixed(1)}km</span>
                <div class="mt-2 flex items-center gap-2 text-sm">
                  <span class="text-green-600">ğŸ‘ ${shop.upvotes || 0}</span>
                  <span class="text-red-600">ğŸ‘ ${shop.downvotes || 0}</span>
                </div>
              </div>
            </div>
            ${shop.url ? `
              <div class="mt-3">
                <a href="${shop.url}" target="_blank" rel="noopener noreferrer"
                   class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800">
                  è©³ç´°ã‚’è¦‹ã‚‹ â†’
                </a>
              </div>
            ` : ''}
          </div>
        `).join('');
      }
    }

    // ========================================
    // æ¤œç´¢åŠå¾„æ›´æ–°
    // ========================================
    function updateRadius(value) {
      searchRadius = parseInt(value);
      document.getElementById('radius-value').textContent = value;
      updateShopsDisplay();
    }

    // ========================================
    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äº‹æ¥­è€…èª­ã¿è¾¼ã¿
    // ========================================
    async function loadOnlineMerchants() {
      if (USE_DUMMY_DATA || !supabase) {
        onlineMerchants = dummyOnlineMerchants;
      } else {
        const { data, error } = await supabase
          .from('online_merchants')
          .select('*')
          .eq('status', 'approved');
        if (error) {
          console.error('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äº‹æ¥­è€…ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          onlineMerchants = dummyOnlineMerchants;
        } else {
          onlineMerchants = data || [];
        }
      }

      // ã‚µãƒ¼ãƒ“ã‚¹ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°
      const types = [...new Set(onlineMerchants.map(m => m.service_type).filter(Boolean))];
      const select = document.getElementById('service-type-filter');
      select.innerHTML = '<option value="all">ã™ã¹ã¦</option>' +
        types.map(t => `<option value="${t}">${t}</option>`).join('');

      filterMerchants();
    }

    // ========================================
    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äº‹æ¥­è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    // ========================================
    function filterMerchants() {
      const query = document.getElementById('search-query').value.toLowerCase();
      const typeFilter = document.getElementById('service-type-filter').value;

      const filtered = onlineMerchants.filter(m => {
        const matchesSearch = !query ||
          m.name.toLowerCase().includes(query) ||
          (m.description && m.description.toLowerCase().includes(query)) ||
          (m.tags && m.tags.some(t => t.toLowerCase().includes(query)));
        const matchesType = typeFilter === 'all' || m.service_type === typeFilter;
        return matchesSearch && matchesType;
      });

      document.getElementById('merchants-count').textContent = filtered.length;

      const listEl = document.getElementById('merchants-list');
      if (filtered.length === 0) {
        listEl.innerHTML = `
          <div class="col-span-full bg-white rounded-lg shadow p-8 text-center text-gray-500">
            æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
          </div>
        `;
      } else {
        listEl.innerHTML = filtered.map(m => `
          <div class="bg-white rounded-lg shadow hover:shadow-lg transition-shadow overflow-hidden">
            <div class="p-6 border-b border-gray-100">
              <div class="flex items-start justify-between">
                <h3 class="text-lg font-semibold text-gray-900">${m.name}</h3>
                ${m.service_type ? `<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">${m.service_type}</span>` : ''}
              </div>
              ${m.description ? `<p class="mt-2 text-sm text-gray-600 line-clamp-3">${m.description}</p>` : ''}
            </div>
            <div class="p-6 space-y-4">
              ${m.jpyc_use_case ? `
                <div>
                  <span class="text-xs font-medium text-gray-500 uppercase">JPYCåˆ©ç”¨æ–¹æ³•</span>
                  <p class="mt-1 text-sm text-gray-900">${m.jpyc_use_case}</p>
                </div>
              ` : ''}
              ${m.platforms && m.platforms.length > 0 ? `
                <div>
                  <span class="text-xs font-medium text-gray-500 uppercase">å¯¾å¿œãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </span>
                  <div class="mt-1 flex flex-wrap gap-1">
                    ${m.platforms.map(p => `<span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">${p}</span>`).join('')}
                  </div>
                </div>
              ` : ''}
              ${m.tags && m.tags.length > 0 ? `
                <div>
                  <span class="text-xs font-medium text-gray-500 uppercase">ã‚¿ã‚°</span>
                  <div class="mt-1 flex flex-wrap gap-1">
                    ${m.tags.map(t => `<span class="px-2 py-0.5 bg-gray-100 text-gray-700 text-xs rounded">#${t}</span>`).join('')}
                  </div>
                </div>
              ` : ''}
              ${m.country ? `<div class="text-sm text-gray-500">å¯¾å¿œå›½: ${m.country}</div>` : ''}
            </div>
            <div class="px-6 py-4 bg-gray-50">
              <a href="${m.url}" target="_blank" rel="noopener noreferrer"
                 class="inline-flex items-center justify-center w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                ã‚µã‚¤ãƒˆã‚’è¨ªå•
                <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
              </a>
            </div>
          </div>
        `).join('');
      }
    }

    // ========================================
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    // ========================================
    function switchTab(tab) {
      const tabShops = document.getElementById('tab-shops');
      const tabOnline = document.getElementById('tab-online');
      const contentShops = document.getElementById('content-shops');
      const contentOnline = document.getElementById('content-online');

      if (tab === 'shops') {
        tabShops.className = tabShops.className.replace('tab-inactive', 'tab-active');
        tabOnline.className = tabOnline.className.replace('tab-active', 'tab-inactive');
        contentShops.classList.remove('hidden');
        contentOnline.classList.add('hidden');
        // åœ°å›³ã‚µã‚¤ã‚ºä¿®æ­£
        setTimeout(() => map && map.invalidateSize(), 100);
      } else {
        tabOnline.className = tabOnline.className.replace('tab-inactive', 'tab-active');
        tabShops.className = tabShops.className.replace('tab-active', 'tab-inactive');
        contentOnline.classList.remove('hidden');
        contentShops.classList.add('hidden');
      }
    }

    // åˆæœŸåŒ–å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
